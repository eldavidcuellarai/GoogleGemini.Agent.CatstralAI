<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Cartas Catastrales - CloudRun AI</title>
    <meta name="description" content="Herramienta de an√°lisis inteligente de documentos catastrales usando AI">
    <meta name="theme-color" content="#4285f4">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='16' fill='%234285f4' rx='2'/><path d='M7 8h10M7 12h6M7 16h8' stroke='white' stroke-width='1.5' stroke-linecap='round'/></svg>">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                        <rect x="3" y="4" width="18" height="16" fill="#4285f4" rx="2"/>
                        <path d="M7 8h10M7 12h6M7 16h8" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <h1>CloudRun AI Catastral</h1>
                    <span class="header-subtitle">An√°lisis inteligente de documentos</span>
                </div>
                <div class="header-controls">
                    <div class="connection-status" id="connectionStatus">
                        <span class="status-indicator offline"></span>
                        <span class="status-text">Sin configurar</span>
                    </div>
                    <button id="themeToggle" class="btn btn--outline btn--sm">
                        <span class="theme-icon">üåô</span>
                        <span class="theme-text">Tema</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Configuration Section -->
        <section class="config-section">
            <div class="config-container">
                <h2>Configuraci√≥n</h2>
                <div class="config-form">
                    <div class="config-header">
                        <div class="config-icon">‚öôÔ∏è</div>
                        <div>
                            <p class="config-description">Configura tu API Key de Google AI Studio para comenzar</p>
                            <a href="https://makersuite.google.com/app/apikey" target="_blank" class="config-link">Obtener API Key ‚Üí</a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="apiKey" class="form-label">
                            <span>API Key de Gemini</span>
                            <span class="label-required">*</span>
                        </label>
                        <div class="api-key-input">
                            <input 
                                type="password" 
                                id="apiKey" 
                                class="form-control" 
                                placeholder="AIzaSy..."
                                autocomplete="off"
                                maxlength="39"
                                pattern="AIza[0-9A-Za-z_-]{35}"
                            >
                            <button type="button" id="toggleApiKey" class="btn btn--outline btn--sm">
                                <span class="show-text">Mostrar</span>
                                <span class="hide-text hidden">Ocultar</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="systemPrompt" class="form-label">
                            <span>Instrucciones del Sistema</span>
                            <span class="label-optional">opcional</span>
                        </label>
                        <textarea 
                            id="systemPrompt" 
                            class="form-control system-prompt-textarea" 
                            rows="4"
                            placeholder="Personaliza c√≥mo debe comportarse el asistente..."
                        >Eres un experto analista de documentos catastrales especializado en el an√°lisis t√©cnico y legal de propiedades. Analiza detalladamente cartas catastrales, extrae informaci√≥n espec√≠fica como superficie, ubicaci√≥n, linderos, valor catastral, coordenadas, y proporciona an√°lisis comparativos cuando se presenten m√∫ltiples documentos. Identifica posibles inconsistencias y brinda recomendaciones. Responde en espa√±ol de manera clara, estructurada y profesional.</textarea>
                        <div class="form-hint">üí° El prompt predeterminado est√° optimizado para an√°lisis catastral</div>
                    </div>
                    
                    <button id="saveConfig" class="btn btn--primary">
                        Guardar Configuraci√≥n
                    </button>
                    
                    <div id="configStatus" class="config-status hidden">
                        <div class="status status--success">
                            ‚úì Configuraci√≥n guardada correctamente
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- File Upload Section -->
        <section class="upload-section">
            <div class="upload-container">
                <h3>Cargar Documentos Catastrales</h3>
                
                <!-- Upload Area -->
                <div id="uploadArea" class="upload-area">
                    <div class="upload-content">
                        <div class="upload-animation">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                                <polyline points="14.5,2 14.5,7.5 20,7.5"/>
                            </svg>
                            <div class="upload-particles">
                                <div class="particle"></div>
                                <div class="particle"></div>
                                <div class="particle"></div>
                            </div>
                        </div>
                        <h4>Arrastra documentos aqu√≠ o haz clic para seleccionar</h4>
                        <div class="upload-specs">
                            <div class="spec-item">
                                <span class="spec-icon">üìÑ</span>
                                <span>PDF, PNG, JPEG, WebP</span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-icon">üìä</span>
                                <span>Hasta 10 archivos</span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-icon">üíæ</span>
                                <span>M√°x. 50MB total</span>
                            </div>
                        </div>
                        <button type="button" class="btn btn--primary btn--upload">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Seleccionar Archivos
                        </button>
                    </div>
                    <input type="file" id="fileInput" multiple accept="image/png,image/jpeg,image/webp,application/pdf" style="display: none;">
                </div>

                <!-- Processing Mode Selection -->
                <div class="processing-mode">
                    <div class="section-header">
                        <h4>Modo de Procesamiento</h4>
                        <div class="section-help" data-tooltip="Selecciona c√≥mo quieres procesar los documentos">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9,9h0a3,3,0,0,1,6,0c0,2-3,3-3,3"/>
                                <path d="m12,17h0"/>
                            </svg>
                        </div>
                    </div>
                    <div class="mode-options">
                        <label class="mode-option">
                            <input type="radio" name="processingMode" value="sequential" checked>
                            <span class="mode-card">
                                <strong>An√°lisis Secuencial</strong>
                                <small>Procesa archivos uno por uno para an√°lisis detallado</small>
                            </span>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="processingMode" value="batch">
                            <span class="mode-card">
                                <strong>Procesamiento por Lotes</strong>
                                <small>Analiza todos los archivos simult√°neamente para comparaci√≥n</small>
                            </span>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="processingMode" value="selective">
                            <span class="mode-card">
                                <strong>An√°lisis Selectivo</strong>
                                <small>Permite elegir archivos espec√≠ficos para procesar</small>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- File Gallery -->
                <div id="fileGallery" class="file-gallery hidden">
                    <div class="gallery-header">
                        <h4>Archivos Cargados (<span id="fileCount">0</span>)</h4>
                        <div class="gallery-actions">
                            <button id="selectAllFiles" class="btn btn--outline btn--sm">Seleccionar Todo</button>
                            <button id="clearAllFiles" class="btn btn--outline btn--sm">Eliminar Todo</button>
                            <select id="sortFiles" class="form-control">
                                <option value="name">Ordenar por Nombre</option>
                                <option value="size">Ordenar por Tama√±o</option>
                                <option value="type">Ordenar por Tipo</option>
                            </select>
                        </div>
                    </div>
                    <div id="fileList" class="file-list"></div>
                </div>

                <!-- Quick Analysis Buttons -->
                <div id="quickAnalysis" class="quick-analysis hidden">
                    <h4>An√°lisis R√°pido</h4>
                    <div class="analysis-buttons">
                        <button class="analysis-btn" data-prompt="compare">
                            üîç Comparar Propiedades
                        </button>
                        <button class="analysis-btn" data-prompt="extract">
                            üìä Extraer Datos
                        </button>
                        <button class="analysis-btn" data-prompt="surface">
                            üìè Mayor Superficie
                        </button>
                        <button class="analysis-btn" data-prompt="summary">
                            üìã Resumen Consolidado
                        </button>
                        <button class="analysis-btn" data-prompt="inconsistencies">
                            ‚ö†Ô∏è Detectar Inconsistencias
                        </button>
                        <button class="analysis-btn" data-prompt="ranking">
                            üèÜ Ranking por Valor
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Analysis Section -->
        <section class="analysis-section">
            <div class="analysis-container">
                <!-- Navigation Tabs -->
                <div class="analysis-nav">
                    <div class="nav-tabs">
                        <button class="nav-tab active" data-tab="ocr">OCR + IA</button>
                        <button class="nav-tab" data-tab="validation">Validaci√≥n</button>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- OCR + IA Tab -->
                    <div id="ocrTab" class="tab-panel active">
                        <div class="panel-split">
                            <!-- Left Panel - Document Upload -->
                            <div class="panel-left">
                                <div class="panel-header">
                                    <h3 id="uploadSectionTitle">Documentos de Propiedad</h3>
                                    <div class="document-type-slider">
                                        <div class="slider-container">
                                            <input type="radio" name="docType" id="propiedadType" value="propiedad" checked>
                                            <input type="radio" name="docType" id="gravamenType" value="gravamen">
                                            <div class="slider-labels">
                                                <label for="propiedadType" class="slider-label">Documentos de Propiedad</label>
                                                <label for="gravamenType" class="slider-label">Documentos de Gravamen</label>
                                            </div>
                                            <div class="slider-indicator"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Upload Section -->
                                <div class="upload-section-compact">
                                    <h4 id="uploadTitle">Carga de Documentos de Propiedad</h4>
                                    <div class="upload-area-compact" id="uploadAreaCompact">
                                        <div class="upload-content-compact">
                                            <div class="upload-icon">ÔøΩ</div>
                                            <p>Arrastra y suelta tus documentos aqu√≠</p>
                                            <p class="upload-hint">o</p>
                                            <button type="button" class="btn btn--primary btn--sm" id="selectFilesBtn">
                                                Seleccionar Archivos
                                            </button>
                                        </div>
                                        <div class="upload-specs-compact">
                                            <small>Formatos soportados: PDF con texto. Tama√±o m√°ximo: 30 MB.</small>
                                        </div>
                                        <input type="file" id="fileInputCompact" multiple accept="application/pdf,image/*" style="display: none;">
                                    </div>
                                </div>

                                <!-- Uploaded Files List -->
                                <div class="uploaded-files-section">
                                    <h4 id="uploadedFilesTitle">Archivos Subidos (Propiedad)</h4>
                                    <div id="uploadedFilesList" class="uploaded-files-list">
                                        <!-- Files will be dynamically added here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Right Panel - Extracted Data -->
                            <div class="panel-right">
                                <div class="panel-header">
                                    <h3>Datos Extra√≠dos (Propiedad)</h3>
                                    <div class="panel-tabs">
                                        <button class="panel-tab active" data-panel="tables">Tablas</button>
                                        <button class="panel-tab" data-panel="chat">Chat</button>
                                    </div>
                                </div>

                                <!-- Tables Panel -->
                                <div id="tablesPanel" class="data-panel active">
                                    <div id="extractedDataContainer" class="extracted-data-container">
                                        <!-- No data message (initially shown) -->
                                        <div id="noDataMessage" class="no-data-placeholder">
                                            <div class="no-data-icon">üìÑ</div>
                                            <h4>No hay datos extra√≠dos</h4>
                                            <p>Sube un documento para ver los datos extra√≠dos aqu√≠.</p>
                                        </div>

                                        <!-- Property Information Card -->
                                        <div class="data-card" id="informacionPredioCard" style="display: none;">
                                            <div class="card-header">
                                                <div class="card-icon">üè†</div>
                                                <h4>Informaci√≥n del Predio</h4>
                                            </div>
                                            <div class="card-content" id="informacionPredioContent">
                                                <!-- Dynamic content will be added here -->
                                            </div>
                                        </div>

                                        <!-- Measurements and Boundaries Card -->
                                        <div class="data-card" id="medidasColindanciasCard" style="display: none;">
                                            <div class="card-header">
                                                <div class="card-icon">üìê</div>
                                                <h4>Medidas y Colindancias</h4>
                                            </div>
                                            <div class="card-content" id="medidasColindanciasContent">
                                                <!-- Dynamic content will be added here -->
                                            </div>
                                        </div>

                                        <!-- Titulares Card (Propiedad only) -->
                                        <div class="data-card" id="titularesCard" style="display: none;">
                                            <div class="card-header">
                                                <div class="card-icon">üë•</div>
                                                <h4>Titulares</h4>
                                            </div>
                                            <div class="card-content" id="titularesContent">
                                                <!-- Dynamic content will be added here -->
                                            </div>
                                        </div>

                                        <!-- Acto Jur√≠dico Card -->
                                        <div class="data-card" id="actoJuridicoCard" style="display: none;">
                                            <div class="card-header">
                                                <div class="card-icon">‚öñÔ∏è</div>
                                                <h4>Acto Jur√≠dico</h4>
                                            </div>
                                            <div class="card-content" id="actoJuridicoContent">
                                                <!-- Dynamic content will be added here -->
                                            </div>
                                        </div>

                                        <!-- Datos Registrales Card -->
                                        <div class="data-card" id="datosRegistralesCard" style="display: none;">
                                            <div class="card-header">
                                                <div class="card-icon">üìú</div>
                                                <h4>Datos Registrales</h4>
                                            </div>
                                            <div class="card-content" id="datosRegistralesContent">
                                                <!-- Dynamic content will be added here -->
                                            </div>
                                        </div>

                                        <!-- Antecedentes Card (Propiedad only) -->
                                        <div class="data-card" id="antecedentesCard" style="display: none;">
                                            <div class="card-header">
                                                <div class="card-icon">üìö</div>
                                                <h4>Antecedentes</h4>
                                            </div>
                                            <div class="card-content" id="antecedentesContent">
                                                <!-- Dynamic content will be added here -->
                                            </div>
                                        </div>

                                        <!-- Calidad de Extracci√≥n Card -->
                                        <div class="data-card" id="calidadExtraccionCard" style="display: none;">
                                            <div class="card-header">
                                                <div class="card-icon">üéØ</div>
                                                <h4>Calidad de Extracci√≥n</h4>
                                            </div>
                                            <div class="card-content" id="calidadExtraccionContent">
                                                <!-- Dynamic content will be added here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                    <!-- Property Information Card -->
                                    <div class="data-card">
                                        <div class="card-header">
                                            <div class="card-icon">üè†</div>
                                            <h4>Informaci√≥n del Predio</h4>
                                        </div>
                                        <div class="card-content">
                                            <div class="data-row">
                                                <span class="data-label">Expediente Catastral:</span>
                                                <span class="data-value">67-269-007</span>
                                            </div>
                                            <div class="data-row">
                                                <span class="data-label">Lote:</span>
                                                <span class="data-value">07</span>
                                            </div>
                                            <div class="data-row">
                                                <span class="data-label">Manzana:</span>
                                                <span class="data-value">269</span>
                                            </div>
                                            <div class="data-row">
                                                <span class="data-label">Superficie:</span>
                                                <span class="data-value">99.692 m¬≤</span>
                                            </div>
                                            <div class="data-row">
                                                <span class="data-label">Colonia:</span>
                                                <span class="data-value">MIRADOR DE APODACA</span>
                                            </div>
                                            <div class="data-row">
                                                <span class="data-label">Municipio:</span>
                                                <span class="data-value">APODACA</span>
                                            </div>
                                            <div class="data-row">
                                                <span class="data-label">C√≥digo Postal:</span>
                                                <span class="data-value">NO_CONSTA</span>
                                            </div>
                                            <div class="data-row">
                                                <span class="data-label">Tipo Predio:</span>
                                                <span class="data-value">TERRENO</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Measurements and Boundaries Card -->
                                    <div class="data-card">
                                        <div class="card-header">
                                            <div class="card-icon">ÔøΩ</div>
                                            <h4>Medidas y Colindancias</h4>
                                        </div>
                                        <div class="card-content">
                                            <div class="data-row">
                                                <span class="data-label">Norte:</span>
                                                <span class="data-value">6.01 M (seis metros un cent√≠metro) a colindar con CERRO DE LA SILLA</span>
                                            </div>
                                            <div class="data-row">
                                                <span class="data-label">Sur:</span>
                                                <span class="data-value">6.90 M (seis metros ochenta cent√≠metros) a dar frente a la calle PICO ANETO</span>
                                            </div>
                                            <div class="data-row">
                                                <span class="data-label">Este:</span>
                                                <span class="data-value">15.70 M (quince metros setenta y nueve cent√≠metros) a colindar con el lote 08 (ocho)</span>
                                            </div>
                                            <div class="data-row">
                                                <span class="data-label">Oeste:</span>
                                                <span class="data-value">15.70 M (quince metros setenta cent√≠metros) a colindar con el lote 06 (seis)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chat Panel -->
                                <div id="chatPanel" class="data-panel">
                                    <div id="chatMessages" class="chat-messages">
                                        <div class="welcome-message">
                                            <div class="welcome-icon">ÔøΩ</div>
                                            <h4>Chat con IA</h4>
                                            <p>Procesa documentos y haz preguntas sobre los datos extra√≠dos</p>
                                            <p>La IA puede ayudarte a entender y analizar la informaci√≥n de tus documentos</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Chat Input -->
                                    <div class="chat-input-container">
                                        <div class="chat-input-wrapper">
                                            <textarea 
                                                id="chatInput" 
                                                class="chat-input" 
                                                rows="2"
                                                placeholder="Pregunta sobre los datos extra√≠dos..."
                                                disabled
                                            ></textarea>
                                            <button id="sendChatMessage" class="chat-send-btn" type="button" disabled>
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="22" y1="2" x2="11" y2="13"/>
                                                    <polygon points="22,2 15,22 11,13 2,9 22,2"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Validation Tab -->
                    <div id="validationTab" class="tab-panel">
                        <div class="validation-content">
                            <h3>Documentos de Gravamen</h3>
                            <div class="upload-area-compact">
                                <div class="upload-content-compact">
                                    <div class="upload-icon">üìÅ</div>
                                    <p>Arrastra documentos de gravamen aqu√≠</p>
                                    <button type="button" class="btn btn--secondary btn--sm">
                                        Seleccionar Archivos de Gravamen
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="loading-spinner"></div>
            <p id="loadingText">Procesando documentos...</p>
            <div id="loadingProgress" class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h3>Exportar Resultados</h3>
            <div class="export-options">
                <button class="export-option" data-format="json">
                    <strong>JSON</strong>
                    <small>Datos estructurados</small>
                </button>
                <button class="export-option" data-format="csv">
                    <strong>CSV</strong>
                    <small>Tabla comparativa</small>
                </button>
                <button class="export-option" data-format="summary">
                    <strong>Resumen Ejecutivo</strong>
                    <small>Texto consolidado</small>
                </button>
            </div>
            <div class="modal-actions">
                <button id="closeExportModal" class="btn btn--outline">Cancelar</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>